<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinosoft.system.mapper.SysUserPwdHistoryMapper">

    <resultMap id="SysUserPwdHistoryResult" type="com.sinosoft.system.domain.SysUserPwdHistory">
        <id property="historyId" column="history_id"/>
        <result property="userId" column="user_id"/>
        <result property="tenantId" column="tenant_id"/>
        <result property="password" column="password"/>
        <result property="createTime" column="create_time"/>
        <result property="createBy" column="create_by"/>
    </resultMap>

    <!-- 查询用户最近N次的密码历史 -->
    <select id="selectRecentPasswordHistory" resultMap="SysUserPwdHistoryResult">
        SELECT *
        FROM sys_user_pwd_history
        WHERE user_id = #{userId}
        ORDER BY create_time DESC
        LIMIT #{limit}
    </select>

    <!-- 删除超出保留数量的历史记录 -->
    <delete id="deleteExcessHistory">
        DELETE
        FROM sys_user_pwd_history
        WHERE history_id IN (SELECT t.history_id
                             FROM (SELECT history_id
                                   FROM sys_user_pwd_history
                                   WHERE user_id = #{userId}
                                   ORDER BY create_time DESC
                                   LIMIT #{keepCount}, 999999) t)
    </delete>

</mapper>
